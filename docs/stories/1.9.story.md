# Story 1.9: Password Recovery

## Status
Ready for Review

## Story
**As a** user who forgot their password,
**I want** to reset my password via email,
**so that** I can regain access to my account.

## Acceptance Criteria
1. Password reset flow initiated from login screen
2. Reset email sent via Supabase Auth
3. Password reset confirmation screen with success messaging
4. Error handling for invalid reset attempts

## Tasks / Subtasks
- [x] Add password reset link to LoginScreen (AC: 1)
  - [x] Add "Forgot Password?" link below login form
  - [x] Navigate to password reset screen when pressed
  - [x] Style link consistently with existing form elements
  - [x] Handle navigation state and proper back navigation
- [x] Create PasswordResetScreen component (AC: 1, 2)
  - [x] Implement email input field with validation
  - [x] Add reset password button with loading states
  - [x] Integrate with Supabase Auth resetPasswordForEmail method
  - [x] Style screen using React Native Elements (consistent with auth screens)
- [x] Implement password reset confirmation flow (AC: 3)
  - [x] Create confirmation screen showing success message
  - [x] Add instructions for checking email and next steps
  - [x] Provide navigation back to login screen
  - [x] Handle successful reset request with user-friendly messaging
- [x] Add comprehensive error handling (AC: 4)
  - [x] Handle invalid email format errors
  - [x] Handle non-existent email account errors
  - [x] Handle rate limiting and security-related errors
  - [x] Display user-friendly error messages following error handling strategy
- [x] Update navigation integration (AC: 1)
  - [x] Add password reset screen to auth stack navigation
  - [x] Configure proper screen headers and navigation options
  - [x] Ensure proper TypeScript navigation typing
  - [x] Test navigation flow from login to reset and back
- [x] Write focused tests following testing strategy (Testing Standards Compliance)
  - [x] Test email validation logic and form submission
  - [x] Test error handling scenarios with mocked auth service
  - [x] Test navigation flows and success states
  - [x] Minimal tests focusing on business logic only

## Dev Notes

### Previous Story Insights
From Story 1.6: Supabase Auth service successfully implemented with comprehensive auth methods including resetPasswordForEmail. From Story 1.7 & 1.8: Auth screen patterns established for form validation, error handling, and consistent UI styling using React Native Elements. LoginScreen component ready for "Forgot Password?" link integration.

### Data Models
Password reset utilizes existing user authentication data structures [Source: architecture/data-models.md#user-model]:
- **User Model**: Password reset targets existing user records by email
- **Session Data**: Supabase Auth manages reset tokens automatically
- **Email Verification**: Reset flow sends secure email with reset link
- **Profile Data**: User profile remains unchanged during reset process

### Authentication Service Integration
Password reset uses existing authentication service [Source: architecture/components.md#authentication-service]:
- **resetPasswordForEmail(email)**: Supabase Auth method for password reset
- **Session Management**: Reset invalidates existing sessions for security
- **Email Templates**: Supabase Auth provides built-in reset email templates
- **Error Handling**: Consistent ApiResponse format from existing auth service

### Component Specifications
**Password Reset Screen Component** [Source: architecture/frontend-architecture.md#component-architecture]:
- **Location**: `app/src/screens/auth/PasswordResetScreen.tsx` (new file)
- **Dependencies**: useAuth hook, React Navigation, React Native Elements
- **State Management**: Form state with validation, loading states, success confirmation
- **Navigation Integration**: Part of AuthStack navigator configuration

### API Specifications
Password reset uses Supabase Auth endpoints [Source: architecture/components.md#authentication-service]:
- **Endpoint**: Supabase Auth `/auth/v1/recover` for password reset requests
- **Email Delivery**: Automatic email sending via Supabase Auth service
- **Security**: Rate limiting and validation built into Supabase Auth
- **Success Response**: Returns confirmation without revealing user existence

### File Locations
Based on unified project structure, create files at these exact paths [Source: architecture/unified-project-structure.md#unified-project-structure]:
- **Password Reset Screen**: `app/src/screens/auth/PasswordResetScreen.tsx` (new)
- **Password Reset Confirmation Screen**: `app/src/screens/auth/PasswordResetConfirmationScreen.tsx` (new)
- **Auth Stack Navigation**: Update existing `app/src/navigation/RootNavigator.tsx`
- **Shared Types**: Update `shared/types/navigation.ts` (add new screen types)
- **Tests**: `app/src/screens/auth/__tests__/PasswordResetScreen.test.tsx` (new)

### User Authentication Workflow Integration
Password reset flow connects to established auth patterns [Source: architecture/core-workflows.md#user-onboarding-goal-setup-workflow]:
1. User clicks "Forgot Password?" on login screen → navigates to PasswordResetScreen
2. User enters email → calls Supabase Auth resetPasswordForEmail
3. Auth service sends reset email with secure token → shows confirmation screen
4. User receives email and follows link → handled by Supabase Auth automatically
5. User completes password reset in email flow → returns to app login screen

### UI Component Library Usage
Form components should use established design system [Source: architecture/components.md#ui-component-library]:
- **Form Elements**: React Native Elements Input components (consistent with LoginScreen/SignUpScreen)
- **Loading States**: Existing LoadingSpinner component patterns
- **Success/Error Messages**: Alert dialogs following established patterns
- **Navigation Elements**: React Native Elements Button components for actions

### Technical Constraints
- **TypeScript Version**: 5.3+ required with proper form validation types [Source: architecture/tech-stack.md#tech-stack]
- **UI Framework**: React Native Elements 4.0+ for consistent Material Design [Source: architecture/tech-stack.md#tech-stack]
- **State Management**: Local component state for form, no global state needed [Source: architecture/frontend-architecture.md#state-management-architecture]
- **Navigation**: React Navigation v6 with typed navigation params [Source: architecture/frontend-architecture.md#routing-architecture]

### Critical Fullstack Rules
- **Type Sharing**: Use existing navigation params from shared/types [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **API Calls**: Use existing auth service layer, never direct Supabase calls [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Environment Variables**: Access through config objects via existing environment.ts [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Error Handling**: All reset operations must return consistent error format [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **State Updates**: Never mutate auth state directly - use proper auth context patterns [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Async Operations**: Always handle loading and error states in reset UI [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Testing

**Testing Standards from Architecture:**
- **Test Framework**: Jest + React Native Testing Library for UI components [Source: architecture/tech-stack.md#tech-stack]
- **Test Focus**: Minimal testing following "Test the Money, Not the Framework" philosophy [Source: architecture/testing-strategy.md#core-philosophy-test-the-money-not-the-framework]
- **Test Organization**: Follow pattern `app/src/screens/auth/__tests__/` [Source: architecture/testing-strategy.md#file-organization]
- **Password Reset Testing**: Focus on email validation logic and error handling, avoid complex mocking of Supabase Auth [Source: architecture/testing-strategy.md#testing-rules]
- **5-10 Tests Maximum**: Only test business logic that could cause user-blocking failures [Source: architecture/testing-strategy.md#testing-rules]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation with full architecture context | Bob (Scrum Master) |
| 2025-01-09 | 1.1 | Fixed test mocks for PasswordReset screens to prevent route.params undefined errors | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
anthropic/claude-sonnet-4

### Debug Log References
No debug log entries required - implementation followed established patterns from LoginScreen and SignUpScreen components.

### Completion Notes List
- Successfully implemented password recovery flow with navigation-based approach instead of Alert-based approach for better UX
- Maintained consistency with existing auth screen styling and patterns
- Implemented secure error handling that doesn't leak user information (same message for valid/invalid emails)
- Added comprehensive form validation with real-time error clearing
- Created focused unit tests following "Test the Money, Not the Framework" philosophy
- Updated LoginScreen to remove usePasswordReset dependency and use navigation instead
- All acceptance criteria fully implemented and tested

### File List
**New Files:**
- `app/src/screens/auth/PasswordResetScreen.tsx` - Password reset form component
- `app/src/screens/auth/PasswordResetConfirmationScreen.tsx` - Reset confirmation component
- `app/src/screens/auth/__tests__/PasswordResetScreen.test.tsx` - Password reset component tests

**Modified Files:**
- `shared/types/navigation.ts` - Added PasswordReset and PasswordResetConfirmation route types
- `app/src/screens/auth/LoginScreen.tsx` - Updated forgot password to use navigation instead of Alert
- `app/src/navigation/RootNavigator.tsx` - Added password reset screens to AuthStack
- `app/src/screens/auth/__tests__/LoginScreen.test.tsx` - Updated tests for navigation-based forgot password

## QA Results
_To be populated by QA Agent after implementation review_
