# Story 1.2: User Authentication System

## Status
Ready 

## Story
**As a** potential user,  
**I want** to securely create an account and log in,  
**so that** I can access personalized habit tracking features.

## Acceptance Criteria
1. Supabase Auth integration with email/password authentication
2. Sign up flow with email verification requirement
3. Login screen with email/password fields and proper validation
4. Password reset functionality via email
5. Authentication state management with protected routes
6. Row Level Security policies configured for user data isolation
7. Basic user profile storage (email, created date) in Supabase
8. Auth state persistence across app restarts

## Tasks / Subtasks
- [ ] Supabase Auth Service Setup (AC: 1, 8)
  - [ ] Configure Supabase Auth in existing service layer at `/app/src/services/api/supabase.ts`
  - [ ] Implement auth methods in authentication service component
  - [ ] Setup auth state persistence using AsyncStorage
  - [ ] Add auth error handling and logging

- [ ] User Registration Implementation (AC: 2, 7)  
  - [ ] Create SignUpScreen component at `/app/src/screens/auth/SignUpScreen.tsx`
  - [ ] Implement sign-up form with email/password validation
  - [ ] Add email verification flow integration
  - [ ] Create user profile record in profiles table on successful signup
  - [ ] Handle registration errors with user-friendly messages

- [ ] User Login Implementation (AC: 3)
  - [ ] Update existing LoginScreen component at `/app/src/screens/auth/LoginScreen.tsx` 
  - [ ] Implement login form with email/password fields and validation
  - [ ] Add proper error handling for invalid credentials
  - [ ] Include loading states during authentication

- [ ] Password Recovery Flow (AC: 4)
  - [ ] Create ForgotPasswordScreen component at `/app/src/screens/auth/ForgotPasswordScreen.tsx`
  - [ ] Implement password reset request functionality
  - [ ] Add navigation flow for password reset
  - [ ] Handle password reset confirmation

- [ ] Authentication State Management (AC: 5)
  - [ ] Update existing authStore.ts with Supabase Auth integration
  - [ ] Implement protected route logic in RootNavigator.tsx
  - [ ] Add auth state monitoring and session management
  - [ ] Create loading states for auth checks

- [ ] Database Schema & Security (AC: 6, 7)
  - [ ] Implement profiles table structure following database schema
  - [ ] Configure Row Level Security policies for user data isolation
  - [ ] Setup profile creation trigger on user signup
  - [ ] Add proper database indexes for auth performance

## Dev Notes

**Previous Story Insights**: Foundation completed successfully with Supabase client configured, auth store created, and navigation structure in place. Authentication flow can build on existing infrastructure.

**Tech Stack Requirements** [Source: architecture/tech-stack.md]:
- Supabase Auth Latest for authentication with built-in OAuth, magic links, and Row Level Security integration
- React Native Elements 4.0+ for consistent form components
- TypeScript 5.3+ for type-safe auth state management
- AsyncStorage for auth token persistence

**Authentication Architecture** [Source: architecture/backend-architecture.md#authentication-and-authorization]:
- JWT-based authentication flow with Supabase Auth
- Auth state managed via Supabase client with auto-refresh tokens
- Row Level Security policies for user data isolation
- Auth middleware pattern for protected endpoints

**Data Models** [Source: architecture/data-models.md#user-model]:
- User ID: UUID from Supabase Auth UUID
- Profile Data: JSON flexible profile information (name, avatar_url, timezone, onboarding_completed)
- Subscription Tier: enum 'free' | 'premium'
- Notification Preferences: JSON push notification settings
- User table extends auth.users with profiles table

**Database Schema** [Source: architecture/database-schema.md]:
- profiles table references auth.users(id) ON DELETE CASCADE
- Default profile_data includes onboarding_completed: false, timezone: UTC
- Default subscription_tier: 'free'
- Default notification preferences with daily_reminder: true, reminder_time: "09:00"
- RLS policies: users can view/update own profile only

**Authentication Component Specifications** [Source: architecture/components.md#authentication-service]:
- signUp(email, password): Register new user
- signIn(email, password): Authenticate user  
- signOut(): Clear session
- getSession(): Retrieve current auth state
- onAuthStateChange(): Subscribe to auth changes
- Dependencies: Supabase Auth SDK, Secure Storage (Expo SecureStore)

**Frontend Architecture** [Source: architecture/frontend-architecture.md]:
- Auth state managed globally in Zustand store
- Protected route pattern using navigation guards
- Auth service with Supabase client configuration
- AsyncStorage for session persistence

**Core Workflows** [Source: architecture/core-workflows.md#user-onboarding-goal-setup-workflow]:
- User opens app → Check session → No session → Show welcome/auth screen
- Sign up with email → Create account → Store user record → Auth token → Store token securely
- Auth state changes trigger navigation updates between AuthStack and MainTabs

**File Locations** [Source: architecture/unified-project-structure.md]:
- Auth screens: `/app/src/screens/auth/` (SignInScreen.tsx, SignUpScreen.tsx)
- Auth store: `/app/src/stores/authStore.ts` (already exists)
- Auth hook: `/app/src/hooks/useAuth.ts` (already exists)
- Supabase client: `/app/src/services/api/supabase.ts` (already exists)
- Navigation: `/app/src/navigation/RootNavigator.tsx`

**Coding Standards** [Source: architecture/coding-standards.md]:
- Components use PascalCase naming (SignUpScreen.tsx, LoginScreen.tsx)
- Hooks use camelCase with 'use' prefix (useAuth.ts)
- Never make direct HTTP calls - use service layer through Supabase client
- Access environment variables only through config objects
- Always handle loading and error states in UI
- Type interfaces use PascalCase and are defined in shared/types

**Security Requirements** [Source: architecture/database-schema.md]:
- Row Level Security enabled on profiles table
- Auth policies: users can view/update own profile only
- Secure token storage using Expo SecureStore
- No hardcoded secrets or API keys

### Testing
[Source: architecture/testing-strategy.md]

**Test Organization**:
- Auth component tests in `app/src/screens/auth/__tests__/`
- Auth hook tests in `app/src/hooks/__tests__/`
- Auth service tests in `app/src/services/__tests__/`

**Testing Requirements**:
- Unit tests (70% of test pyramid) for auth components, hooks, and services
- Integration tests (30% of test pyramid) for auth flow
- Test file naming: `SignUpScreen.test.tsx`, `useAuth.test.ts`
- Use `@testing-library/react-native` for component testing
- Mock Supabase client for testing auth methods

**Specific Test Cases**:
- SignUpScreen: valid registration, invalid email, password validation, loading states
- LoginScreen: successful login, invalid credentials, loading states  
- useAuth hook: auth state changes, session persistence, logout
- Auth service: signup/signin methods, error handling, token management

**Project Structure Notes**: All authentication requirements align with the defined unified project structure. Auth screens go in `/app/src/screens/auth/`, auth store already exists, and Supabase client is configured. No structural conflicts identified.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References  

### Completion Notes List

### File List

## QA Results
*This section will be populated by the QA agent during review*