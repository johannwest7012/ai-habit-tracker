# Story 1.6: Supabase Authentication Service

## Status
Draft

## Story
**As a** developer,
**I want** Supabase Auth properly integrated,
**so that** users can securely authenticate with email/password.

## Acceptance Criteria
1. Supabase Auth service configured with email/password provider
2. Authentication service layer created with login/signup/logout methods
3. Authentication state management implemented
4. Auth state persistence across app restarts working

## Tasks / Subtasks
- [ ] Configure Supabase Auth service (AC: 1)
  - [ ] Set up email/password authentication provider in Supabase dashboard
  - [ ] Configure auth service settings and redirect URLs
  - [ ] Verify auth configuration with environment variables
  - [ ] Test basic auth configuration with health check
- [ ] Create authentication service layer (AC: 2)
  - [ ] Implement signUp method with email verification
  - [ ] Implement signIn method with error handling
  - [ ] Implement signOut method with session cleanup
  - [ ] Implement password reset functionality
  - [ ] Create profile creation on successful signup
- [ ] Implement authentication state management (AC: 3)
  - [ ] Create auth context provider for app-wide state
  - [ ] Implement auth state change listeners
  - [ ] Set up React Query integration for auth state
  - [ ] Create auth state hooks for components
- [ ] Implement auth state persistence (AC: 4)
  - [ ] Configure session persistence with AsyncStorage
  - [ ] Implement automatic token refresh
  - [ ] Handle app restart auth state recovery
  - [ ] Test auth state persistence across app lifecycles
- [ ] Write comprehensive unit tests (Testing Standards Compliance)
  - [ ] Create tests for authentication service methods
  - [ ] Test auth state management and persistence
  - [ ] Test error handling and edge cases
  - [ ] Test auth hooks in isolation with mocked dependencies

## Dev Notes

### Previous Story Insights
From Story 1.4: State management foundation successfully established with React Query configuration. Authentication hooks (useAuth, useSession, useUser, useSignIn, useSignOut) were created as part of the hook structure but need actual Supabase Auth integration to function properly.

### Data Models
Authentication will handle these core data types [Source: architecture/data-models.md#user-model]:
- **User Model**: Authentication state, profile data, notification preferences
  - id: UUID - Unique user identifier (Supabase Auth UUID)
  - email: string - User email for authentication
  - profile_data: JSON - Flexible profile information (name, avatar_url, timezone, onboarding_completed)
  - subscription_tier: enum - 'free' | 'premium'
  - notification_preferences: JSON - Push notification settings
- **Authentication Flow**: JWT bearer tokens with automatic refresh, Row Level Security integration

### API Specifications
Supabase Auth integration will use these endpoints [Source: architecture/api-specification.md#authentication-requirements]:
- **Auth Endpoints**: `/auth/v1/signup`, `/auth/v1/token` (signin), `/auth/v1/logout`
- **Authentication**: JWT bearer token from Supabase Auth for all API calls
- **Rate Limiting**: Standard auth endpoints have built-in Supabase protection
- **Security**: Row Level Security policies enforce user data isolation

### Component Specifications
**Authentication Service Component from Components Architecture** [Source: architecture/components.md#authentication-service]:
- **Key Interfaces**: signUp(email, password), signIn(email, password), signOut(), getSession(), onAuthStateChange()
- **Dependencies**: Supabase Auth SDK, Secure Storage (Expo SecureStore)
- **Technology Stack**: Supabase Auth, React Context for state distribution
- **State Management**: React Query for server state + React Context for auth state distribution

### Database Schema
Authentication will interact with these database structures [Source: architecture/database-schema.md]:
- **profiles table**: Extends auth.users with profile_data, subscription_tier, notification_preferences
- **Row Level Security**: policies enforce auth.uid() = user_id access patterns
- **Triggers**: update_updated_at automatically manages timestamps
- **Constraints**: subscription_tier enum validation, JSON schema validation for preferences

### File Locations
Based on unified project structure, create/update files at these exact paths [Source: architecture/unified-project-structure.md#unified-project-structure]:
- **Auth Service**: `app/src/services/api/supabaseClient.ts` (update existing)
- **Auth Hooks**: `app/src/hooks/useAuth.ts` (update existing from Story 1.4)
- **Auth Context**: `app/src/contexts/AuthContext.tsx` (new)
- **Types**: `shared/types/models.ts` (update User interface)
- **Config**: `app/src/config/environment.ts` (update for auth settings)
- **Tests**: `app/src/services/__tests__/auth.test.ts`, `app/src/hooks/__tests__/useAuth.test.ts`

### Testing Requirements
**Testing Standards from Architecture** [Source: architecture/testing-strategy.md#test-organization]:
- **Test Framework**: Jest + React Native Testing Library for hooks and auth flows
- **Test Organization**: Follow pattern `app/src/services/__tests__/` and `app/src/hooks/__tests__/`
- **Test Focus**: Unit tests only for this story - auth methods, hooks, state management with mocked dependencies
- **Auth Testing**: Must test signup, signin, signout, token refresh, persistence, error handling in isolation

### Technical Constraints
- **Supabase Auth**: Latest version with email/password provider [Source: architecture/tech-stack.md#tech-stack]
- **TypeScript Version**: 5.3+ required with proper auth type definitions [Source: architecture/tech-stack.md#tech-stack]
- **State Management**: React Query for server state, React Context for auth state [Source: architecture/frontend-architecture.md#state-management-architecture]
- **Storage**: Expo SecureStore for sensitive auth data, AsyncStorage for session persistence [Source: architecture/components.md#authentication-service]

### Critical Fullstack Rules
- **Type Sharing**: Always define auth types in shared/types and import from there [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Environment Variables**: Access only through config objects, never process.env directly [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Error Handling**: All auth operations must return consistent error format [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **State Updates**: Never mutate auth state directly - use proper state management patterns [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Async Operations**: Always handle loading and error states in auth UI [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Backend Authentication Architecture
Integration with backend authentication patterns [Source: architecture/backend-architecture.md#authentication-and-authorization]:
- **Auth Flow**: JWT token verification through Supabase Auth getUser() method
- **Middleware**: requireAuth pattern for protected operations
- **Edge Functions**: All functions validate auth token before processing
- **RLS Policies**: Database policies automatically enforce auth.uid() = user_id patterns

### Service Layer Integration
Authentication service must integrate with existing patterns [Source: architecture/frontend-architecture.md#frontend-services-layer]:
- **Supabase Client**: Use existing `app/src/services/api/supabaseClient.ts` configuration from Story 1.2
- **React Query Integration**: Auth hooks must work with existing React Query setup from Story 1.4
- **Error Handling**: Consistent error format across all auth operations
- **Token Management**: Automatic refresh and secure storage patterns

### Testing

**Testing Standards from Architecture:**
- **Test Framework**: Jest + React Native Testing Library for hooks and components [Source: architecture/tech-stack.md#tech-stack]
- **Test Focus**: Unit tests only for this story - integration tests deferred to avoid development slowdowns
- **Test Organization**: Follow pattern `app/src/hooks/__tests__/` and `app/src/services/__tests__/` [Source: architecture/testing-strategy.md#test-organization]
- **Auth Testing**: Custom authentication hooks and services must have comprehensive unit tests covering all auth flows, error cases, and persistence scenarios with mocked dependencies

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation with full architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
<!-- To be populated by development agent -->

### Debug Log References
<!-- To be populated by development agent -->

### Completion Notes List
<!-- To be populated by development agent -->

### File List
<!-- To be populated by development agent -->

## QA Results
<!-- To be populated by QA agent -->
