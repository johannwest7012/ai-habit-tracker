# Story 1.7: User Registration Flow

## Status
Ready

## Story
**As a** potential user,
**I want** to create a new account with email verification,
**so that** I can securely access the app with a verified identity.

## Acceptance Criteria
1. Sign up screen with email/password fields and validation
2. Email verification requirement implemented
3. Success/error messaging for registration attempts
4. Basic user profile record created in Supabase on successful signup

## Tasks / Subtasks
- [ ] Create SignUpScreen component with form validation (AC: 1)
  - [ ] Implement email/password input fields with proper validation
  - [ ] Add form validation for email format and password requirements
  - [ ] Style form using NativeWind following design system
  - [ ] Add loading states during form submission
- [ ] Integrate with existing Supabase Auth service (AC: 2, 4)
  - [ ] Use signUp method from useAuth hook (already implemented in Story 1.6)
  - [ ] Configure email verification requirement in signup flow
  - [ ] Handle auth state changes after successful registration
  - [ ] Create user profile record using existing profile creation logic
- [ ] Implement success/error messaging (AC: 3)
  - [ ] Add success state for email verification sent
  - [ ] Implement error handling for existing email, weak password, etc.
  - [ ] Display user-friendly error messages following error handling strategy
  - [ ] Add navigation to email verification instructions screen
- [ ] Add navigation integration (AC: 1)
  - [ ] Integrate signup screen into existing auth stack navigation
  - [ ] Add navigation to login screen ("Already have account" link)
  - [ ] Handle successful registration navigation flow
  - [ ] Add back navigation and proper header styling
- [ ] Write focused tests following testing strategy (Testing Standards Compliance)
  - [ ] Test form validation logic for email and password fields
  - [ ] Test error handling scenarios with mocked auth service
  - [ ] Test navigation flows and state management

## Dev Notes

### Previous Story Insights
From Story 1.6: Supabase Auth service successfully implemented with signUp, signIn, signOut methods and comprehensive authentication state management. The signUp method already includes profile creation and email verification, so this story focuses on the UI layer integration with existing auth infrastructure.

### Data Models
User registration will create these data structures [Source: architecture/data-models.md#user-model]:
- **User Model**: Created automatically by Supabase Auth with UUID identifier
- **Profile Data**: JSON object containing name, avatar_url, timezone, onboarding_completed (initially false)
- **Subscription Tier**: Defaults to 'free' tier for new users
- **Notification Preferences**: Default notification settings (daily_reminder: true, reminder_time: "09:00", weekly_summary: true)

### Authentication Service Integration
Registration will use existing authentication service [Source: architecture/components.md#authentication-service]:
- **signUp(email, password)**: Already implemented in Story 1.6, includes profile creation
- **Email Verification**: Built into Supabase Auth configuration
- **Session Management**: Automatic token storage and auth state persistence
- **Error Handling**: Consistent ApiResponse format from existing auth service

### Component Specifications
**SignUp Screen Component** [Source: architecture/frontend-architecture.md#component-architecture]:
- **Location**: `app/src/screens/auth/SignUpScreen.tsx`
- **Dependencies**: useAuth hook, React Navigation, React Native Elements
- **State Management**: Form state with validation, auth loading states
- **Navigation Integration**: Part of AuthStack navigator configuration

### API Specifications
Email/password registration uses Supabase Auth endpoints [Source: architecture/components.md#authentication-service]:
- **Endpoint**: Supabase Auth `/auth/v1/signup`
- **Email Verification**: Automatic email sent via configured Supabase Auth
- **Profile Creation**: Handled by existing signUp method implementation
- **Row Level Security**: User data automatically isolated by Supabase Auth policies

### File Locations
Based on unified project structure, create/update files at these exact paths [Source: architecture/unified-project-structure.md#unified-project-structure]:
- **Signup Screen**: `app/src/screens/auth/SignUpScreen.tsx` (new)
- **Auth Stack Navigation**: `app/src/navigation/RootNavigator.tsx` (update existing)
- **Shared Types**: `shared/types/navigation.ts` (update for new screen)
- **Tests**: `app/src/screens/auth/__tests__/SignUpScreen.test.ts` (new)

### User Onboarding Workflow Integration
Registration flow follows established onboarding pattern [Source: architecture/core-workflows.md#user-onboarding-goal-setup-workflow]:
1. User completes signup form â†’ calls Supabase Auth
2. Auth creates user record and sends verification email
3. User profile created with default settings
4. Navigation to email verification instruction screen
5. After verification, redirect to onboarding welcome flow

### UI Component Library Usage
Form components should use established design system [Source: architecture/components.md#ui-component-library]:
- **Form Elements**: React Native Elements Input components
- **Styling**: NativeWind utility classes for consistent design
- **Loading States**: Existing LoadingSpinner component
- **Success/Error Messages**: Consistent messaging patterns from error handling strategy

### Technical Constraints
- **TypeScript Version**: 5.3+ required with proper form validation types [Source: architecture/tech-stack.md#tech-stack]
- **UI Framework**: React Native Elements 4.0+ for consistent Material Design [Source: architecture/tech-stack.md#tech-stack]
- **State Management**: React Query for server state, local component state for form [Source: architecture/frontend-architecture.md#state-management-architecture]
- **Navigation**: React Navigation v6 with typed navigation params [Source: architecture/frontend-architecture.md#routing-architecture]

### Critical Fullstack Rules
- **Type Sharing**: Define navigation params in shared/types and import from there [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **API Calls**: Use existing auth service layer, never direct Supabase calls [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Environment Variables**: Access through config objects via existing environment.ts [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Error Handling**: All registration operations must return consistent error format [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **State Updates**: Never mutate auth state directly - use proper auth context patterns [Source: architecture/coding-standards.md#critical-fullstack-rules]
- **Async Operations**: Always handle loading and error states in registration UI [Source: architecture/coding-standards.md#critical-fullstack-rules]

### Testing

**Testing Standards from Architecture:**
- **Test Framework**: Jest + React Native Testing Library for UI components [Source: architecture/tech-stack.md#tech-stack]
- **Test Focus**: Minimal testing following "Test the Money, Not the Framework" philosophy [Source: architecture/testing-strategy.md#core-philosophy-test-the-money-not-the-framework]
- **Test Organization**: Follow pattern `app/src/screens/auth/__tests__/` [Source: architecture/testing-strategy.md#file-organization]
- **Registration Testing**: Focus on form validation logic and error handling, avoid complex mocking of Supabase Auth [Source: architecture/testing-strategy.md#testing-rules]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-09 | 1.0 | Initial story creation with full architecture context | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be filled by development agent_

### Debug Log References
_To be filled by development agent_

### Completion Notes List
_To be filled by development agent_

### File List
_To be filled by development agent_

## QA Results
_To be filled by QA agent after story completion_
